<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProgFlash</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 12px; }
    button { margin-right: 6px; }
    #versionBar { font-size: 12px; opacity: 0.85; margin-top: 6px; line-height: 1.35; }
    #versionBar code { font-family: Consolas, monospace; }
    #previewWrap { margin-top: 10px; border: 1px solid #ccc; padding: 8px; background: #fafafa; }
    #previewTitle { font-size: 12px; margin-bottom: 6px; opacity: 0.85; }
    #previewCanvas { border: 1px solid #999; background: #000; image-rendering: pixelated; display: block; }
    #debugBox { white-space: pre; border: 1px solid #ccc; padding: 8px; height: 260px; overflow: auto; background: #fff; }
  </style>
</head>

<body>
  <h2>ProgFlash</h2>

  <div>
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <button id="autoFindBtn">Auto find</button>
    <button id="clearLockBtn">Clear lock</button>
    <button id="testFlashBtn">Test flash</button>

    <div id="versionBar">
      Version: <code id="appVersion">unknown</code> |
      Build: <code id="appBuild">unknown</code> |
      Loaded: <code id="loadedAt">unknown</code><br/>
      Saved lock: <code id="savedLock">none</code>
    </div>
  </div>

  <pre>
Status: <span id="status">Idle</span>
Mode: <span id="mode">Not running</span>
Lock: <span id="lock">none</span>
Progress: <span id="progress">â€”</span>
  </pre>

  <div id="previewWrap">
    <div id="previewTitle">Capture preview (stage scan / verify)</div>
    <canvas id="previewCanvas" width="520" height="320"></canvas>
  </div>

  <div style="margin-top:10px;"><b>Debug</b></div>
  <pre id="debugBox"></pre>

  <script>
    // Cache buster build id
    window.APP_VERSION = "0.5.1";
    window.BUILD_ID = "build-" + Date.now();

    document.getElementById("appVersion").textContent = window.APP_VERSION;
    document.getElementById("appBuild").textContent = window.BUILD_ID;
    document.getElementById("loadedAt").textContent = new Date().toLocaleString();

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src + (src.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(window.BUILD_ID);
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("Failed to load: " + src));
        document.head.appendChild(s);
      });
    }

    loadScript("matcher.js")
      .then(() => loadScript("app.js"))
      .catch(err => {
        document.getElementById("debugBox").textContent = String(err && err.message ? err.message : err);
      });
  </script>
</body>
</html>
