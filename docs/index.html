<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProgFlash</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 12px; }
    .row { margin-bottom: 10px; }
    button { margin-right: 6px; }
    label { font-size: 12px; margin-right: 10px; }
    input[type="range"] { vertical-align: middle; }

    #debugBox {
      white-space: pre;
      border: 1px solid #ccc;
      padding: 8px;
      height: 260px;
      overflow: auto;
      background: #fff;
    }

    #versionBar {
      font-size: 12px;
      opacity: 0.85;
      margin-top: 6px;
      line-height: 1.4;
    }
    #versionBar code { font-family: Consolas, monospace; }

    #previewWrap {
      margin-top: 10px;
      border: 1px solid #ccc;
      padding: 8px;
      background: #fafafa;
    }
    #previewTitle { font-size: 12px; margin-bottom: 6px; opacity: 0.85; }

    #previewCanvas {
      border: 1px solid #999;
      background: #000;
      image-rendering: pixelated;
      display: block;
      cursor: crosshair;
    }

    #hint {
      font-size: 12px;
      margin-top: 6px;
      opacity: 0.9;
      line-height: 1.35;
    }

    #qualityLine {
      font-size: 12px;
      margin-top: 6px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      background: #fff;
      line-height: 1.35;
    }
    #qualityLine code { font-family: Consolas, monospace; }
    #suggestion { margin-top: 4px; opacity: 0.9; }

    #viewControls {
      margin-top: 6px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    #viewControls code { font-family: Consolas, monospace; }
  </style>
</head>

<body>
  <h2>ProgFlash</h2>

  <div class="row">
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <button id="testFlashBtn">Test flash</button>
    <button id="calibrateBtn" title="Auto-freezes. Then drag a box on the zoomable preview.">Calibrate</button>
    <button id="freezeBtn" title="Freeze/unfreeze the preview frame.">Freeze</button>
    <button id="resetViewBtn" title="Reset zoom/pan.">Reset view</button>

    <div id="versionBar">
      Version: <code id="appVersion">unknown</code> |
      Build: <code id="appBuild">unknown</code> |
      Loaded: <code id="loadedAt">unknown</code><br/>
      Calibrated WIDE: <code id="calibWide">none</code> |
      Calibrate mode: <code id="calibMode">off</code> |
      Frame: <code id="frameMode">live</code>
    </div>
  </div>

  <div class="row">
    <div>Status: <span id="status">Idle</span></div>
    <div>Mode: <span id="mode">Not running</span></div>
    <div>Lock: <span id="lock">none</span></div>
    <div>Progress: <span id="progress">—</span></div>
  </div>

  <div id="previewWrap">
    <div id="previewTitle">Capture preview (scan region is drawn here)</div>

    <!-- Bigger canvas so you can actually work -->
    <canvas id="previewCanvas" width="520" height="320"></canvas>

    <div id="viewControls">
      <label>
        Zoom:
        <input id="zoomSlider" type="range" min="1" max="4" step="0.25" value="1" />
        <code id="zoomLabel">1.00×</code>
      </label>
      <span>Pan: right-drag or hold <code>Space</code> + drag</span>
    </div>

    <div id="qualityLine">
      Anchor quality: <code id="qualityScore">—</code>
      <span id="qualityDetail"></span>
      <div id="suggestion">Suggestion: <span id="suggestionText">—</span></div>
    </div>

    <div id="hint">
      Calibrate freezes the frame so it’s smooth. Then zoom in and drag a tight box around stable frame/texture/borders.
      Avoid dynamic text and the moving green fill.
    </div>
  </div>

  <div style="margin-top:10px;"><b>Debug</b></div>
  <pre id="debugBox"></pre>

  <script>
    window.APP_VERSION = "0.4.4";
    window.BUILD_ID = "build-" + Date.now();

    document.getElementById("appVersion").textContent = window.APP_VERSION;
    document.getElementById("appBuild").textContent = window.BUILD_ID;
    document.getElementById("loadedAt").textContent = new Date().toLocaleString();

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src + (src.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(window.BUILD_ID);
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("Failed to load: " + src));
        document.head.appendChild(s);
      });
    }

    loadScript("matcher.js")
      .then(() => loadScript("app.js"))
      .catch(err => {
        document.getElementById("debugBox").textContent = String(err && err.message ? err.message : err);
      });
  </script>
</body>
</html>
